<!DOCTYPE html>
 
<html>
    <head>
        <title>News Aggregator</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="main.css" type="text/css"/>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
    </head>
    <body onload="openSocket()">
 
        <div id="newsCubeArea">
            
        </div>
       

        <div id="titleHeader">
            <h1>NewsSquare</h1>
        </div>

        <div id="sideBar">
            <h2>Menu</h2>
            <span id="sideBarButton" onclick="handleSideBarClick()">></span>
            <br>
            <h2>Categories</h2>
            <ul id="sideBarList">
                <li id="allStoriesSideBar"><input type="checkbox" onchange="activateAllCategories()" checked="true"/>All</li>
            </ul>

        </div>

        <!-- Script to utilise the WebSocket -->
        <script type="text/javascript">
                       
            var webSocket;
            var messages = document.getElementById("messages");
            var categoriesCreated = false;

            var test = 
            [
                {
                    "title": "SURGEFEED",
                    "description": "Feed desc.",
                    "updates": [
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "sport",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "world",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "uk",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JOB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JAB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                    ]
                },

                {
                    "title": "JEB",
                    "description": "Feed desc.",
                    "updates": [
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "world",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "technology",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                    ]
                }
            ]

            var inputElement = document.createElement('button');
            var inputElementText = document.createTextNode("NEWS MAKER");
            inputElement.appendChild(inputElementText);
            inputElement.addEventListener('click', function() {
                updateNews(test);
            });


            // document.addEventListener('DOMContentLoaded', function() {
            //     loadPreferences();
            // });

            function loadPreferences() {
                var pattern = /(\w*)CatPref\w*/;
                for (var key in localStorage) {
                    var match = pattern.exec(key);
                    if (match != null) {
                        //console.log(document.getElementById(ukCheck));
                        if (localStorage[key] === "true") {
                            [match[1] + "Check"].checked = true;
                            window[match[1]+"Check"].checked = true;
                        } else {
                            window[match[1]+"Check"].checked = false;
                        }
                    }
                }
            }



            document.getElementById("titleHeader").appendChild(inputElement);
           
            function openSocket(){
                // Ensures only one connection is open at a time
                if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
                    console.log("WebSocket is already opened.");
                    return;
                }
                // Create a new instance of the websocket
                webSocket = new WebSocket("ws://localhost:8080/NewsAggregator/test");
                 
                /**
                 * Binds functions to the listeners for the websocket.
                 */
                webSocket.onopen = function(event){
                    console.log("Connection open");
                };
 
                webSocket.onmessage = function(event){
                    console.log("Message arrived");
                    updateNews(JSON.parse(event.data));
                };
 
                webSocket.onclose = function(event){
                    console.log("Connection closed");
                };
            }


            var sideBarExpanded = false;

            function expandSideBar() {
                document.getElementById("sideBar").style.width = "300px";
                document.getElementById("sideBarButton").style.marginLeft = "250px";
                document.getElementById("sideBarButton").style.right = "0";
                sideBarExpanded = true;
            }

            function shrinkSideBar() {
                document.getElementById("sideBar").style.width = "40px";
                document.getElementById("sideBarButton").style.marginLeft = "0";
                sideBarExpanded = false;
            }

            function handleSideBarClick() {
                if (sideBarExpanded) {
                    shrinkSideBar();
                } else {
                    expandSideBar();
                }
            }

            var allSideBar = document.getElementById("allStoriesSideBar");

            // allSideBar.addEventListener('click', function() {
            //     //sort by publication time
            // });

            var newsStoriesCategorised = {};
            // var categories = ["uk", "england", "scotland", "ireland", "wales", "world", "us", "americas", "middle_east", "europe", "australia", "asia", "africa", "business", "politics", "health", "education", "science", "technology", "entertainment", "travel", "sport"];

            // newsStoriesCategorised.uk = [];
            // newsStoriesCategorised.england = [];
            // newsStoriesCategorised.scotland = [];
            // newsStoriesCategorised.ireland = [];
            // newsStoriesCategorised.wales = [];
            // newsStoriesCategorised.world = [];
            // newsStoriesCategorised.us = [];
            // newsStoriesCategorised.americas = [];
            // newsStoriesCategorised.middle_east = [];
            // newsStoriesCategorised.europe = [];
            // newsStoriesCategorised.australia = [];
            // newsStoriesCategorised.asia = [];
            // newsStoriesCategorised.africa = [];
            // newsStoriesCategorised.business = [];
            // newsStoriesCategorised.politics = [];
            // newsStoriesCategorised.health = [];
            // newsStoriesCategorised.education = [];
            // newsStoriesCategorised.science = [];
            // newsStoriesCategorised.technology = [];
            // newsStoriesCategorised.entertainment = [];
            // newsStoriesCategorised.travel = [];
            // newsStoriesCategorised.sport = [];

            //console.log(newsStoriesCategorised);

            function updateNews(data) {
                for (var i = 0; i < data.length; i++) {
                    //console.log(data[i]);
                    if (data[i].updates === undefined) {
                        continue;
                    }
                    var category = data[i].category;
                    console.log(data[i]);
                    for (var j = 0; j < data[i].updates.length; j++) {
                        if (category != "") {
                            //console.log(newsStoriesCategorised);
                            if (newsStoriesCategorised[category] === undefined) {
                                newsStoriesCategorised[category] = [];
                            }
                            if (newsStoriesCategorised[category].indexOf(data[i].updates[j]) === -1) {
                                newsStoriesCategorised[category].push(data[i].updates[j]);
                                console.log(newsStoriesCategorised[category]);
                            } else {
                                console.log("Leaving out dup");
                            }
                        }
                    }
                    // for (var j = 0; j < data[i].updates.length; j++) {
                    //  console.log(data[i].updates[j]);
                    //     createNewsCube(data[i].updates[j]);
                    // }
                }

                createCategoryAreas();

                for (var key in newsStoriesCategorised) {
                    //console.log(key);
                    if (!newsStoriesCategorised.hasOwnProperty(key)) continue;
                    for (var i = 0; i < newsStoriesCategorised[key].length; i++) {
                        createNewsCube(newsStoriesCategorised[key][i], key);
                    }
                }
            }

            function createCategoryAreas() {
                if (categoriesCreated == true) {
                    return;
                }
                for (var category in newsStoriesCategorised) {
                    var div = document.createElement("div");
                    div.setAttribute('id', getCategoryDiv(category));
                    div.setAttribute('class', 'categoryDiv');
                    var catH1 = document.createElement("h1");
                    var catH1Text = document.createTextNode(category.toUpperCase());
                    catH1.appendChild(catH1Text);
                    div.appendChild(catH1);
                    document.getElementById("newsCubeArea").appendChild(div);

                    var list = document.getElementById("sideBarList");
                    var listItem = document.createElement("li");
                    var input = document.createElement("input");
                    var categoryFirstLetterCapital = category.charAt(0).toUpperCase() + category.slice(1);
                    var inputText = document.createTextNode(categoryFirstLetterCapital);
                    input.setAttribute('id', category+"Check");
                    input.setAttribute('type', "checkbox");
                    input.setAttribute('checked', "true");
                    //console.log(input);
                    input.onchange = categoryCheckBoxCallback(category, input);

                    listItem.appendChild(input);
                    listItem.appendChild(inputText);
                    list.appendChild(listItem);
                }
                categoriesCreated = true;
            }

            function categoryCheckBoxCallback(category, input) {
                return function() {
                    filterNews(category, input);
                }
            }

            function createCategoryCubes(category) {
                for (var i = 0; i < newsStoriesCategorised[category].length; i++) {
                    createNewsCube(newsStoriesCategorised[category][i], category);
                }
            }

            function createNewsCube(storyObject, category) {
                //Data should be ONE single news story.

                //console.log(storyObject);
                var newsCube = document.createElement("div");
                var newsCubeContent = document.createElement("div");

                var newsCubeImageLink = document.createElement("a");
                newsCubeImageLink.setAttribute('href', storyObject.link);
                newsCubeImageLink.setAttribute('target', 'target="_blank"');

                var newsCubeHeadlineLink = newsCubeImageLink.cloneNode(false);

                var newsCubeHeadline = document.createElement("p");
                var titleTextNode = document.createTextNode(storyObject.title);
                newsCubeHeadline.appendChild(titleTextNode);

                var newsCubeDescription = document.createElement("p");
                var descriptionTextNode = document.createTextNode(storyObject.description);
                newsCubeDescription.appendChild(descriptionTextNode);


                var newsCubeImage = document.createElement("img");
                newsCubeImage.setAttribute('src', storyObject.media);

                newsCube.setAttribute('class', "newsCube");
                newsCubeContent.setAttribute('class', "newsCubeContent");
                newsCubeHeadline.setAttribute('class', "newsCubeHeadline");
                newsCubeDescription.setAttribute('class', "newsCubeDescription");
                newsCubeImage.setAttribute('class', "newsCubeImage");

                var categoryDiv = getCategoryDiv(category);
                document.getElementById(categoryDiv).appendChild(newsCube);
                newsCube.appendChild(newsCubeContent);
                newsCubeContent.appendChild(newsCubeImageLink);
                newsCubeContent.appendChild(newsCubeHeadlineLink);
                newsCubeImageLink.appendChild(newsCubeImage);
                newsCubeHeadlineLink.appendChild(newsCubeHeadline);
                newsCubeHeadlineLink.appendChild(newsCubeDescription);
            }

            function filterNews(category, checkBox) {
                var newsCubes = document.getElementsByClassName("newsCube");
                // for (var i = 0; i < newsCubes.length; i++) {
                var categoryDiv = document.getElementById(getCategoryDiv(category));
                if (checkBox.checked) {
                    localStorage.setItem(category + 'CatPref', 'true');
                    // categoryDiv.style.visibility = "visible";

                    var div = document.createElement("div");
                    div.setAttribute('id', getCategoryDiv(category));
                    div.setAttribute('class', 'categoryDiv');
                    var catH1 = document.createElement("h1");
                    var catH1Text = document.createTextNode(category.toUpperCase());
                    catH1.appendChild(catH1Text);
                    div.appendChild(catH1);
                    document.getElementById("newsCubeArea").appendChild(div);

                    // newsCubes[i].style.visibility = "visible";
                    createCategoryCubes(category);
                } else {
                    localStorage.setItem(category + 'CatPref', 'false');
                    var categoryChildrenLength = categoryDiv.children.length;
                    for (var i = 1; i < categoryChildrenLength; i++) {
                        // categoryDiv.style.opacity = '0';
                        // setTimeout(function() { })
                        categoryDiv.removeChild(categoryDiv.children[1]);
                        console.log(categoryDiv.children.length);
                        console.log(categoryDiv.children);
                    }
                    newsCubeArea.removeChild(categoryDiv);
                    // categoryDiv.style.visibility = "hidden";
                    // newsCubes[i].style.visibility = "hidden";
                }
                //     if (newsCubes[i].children[0].children[2].innerHTML === category) {
                //     }
                // }
            }

            function activateAllCategories() {
                var event;
                if (document.createEvent) {
                    event = document.createEvent("HTMLEvents");
                    event.initEvent("change", true, true);
                } else {
                    event = document.createEventObject();
                    event.eventType = "change";
                }

                event.eventName = "change";

                for (var category in newsStoriesCategorised) {
                    if (document.createEvent) {
                        document.getElementById(category+"Check").dispatchEvent(event);
                    } else {
                        document.getElementById(category+"Check").fireEvent("on" + event.eventType, event);
                    }
                }
            }

            function getCategoryDiv(category) {
                return category + "Area";
            }



        </script>
       
    </body>
</html>