<!DOCTYPE html>
 
<html>
    <head>
        <title>News Aggregator</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="main.css" type="text/css"/>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
    </head>
    <body onload="openSocket()">

        <div id="titleHeader">
            <h1>NewsSquare Aggregator</h1>
        </div>
 
        <div id="newsCubeArea">
            <div id="UKArea" class="categoryDiv">
                <h1>UK</h1>
            </div>

            <div id="worldArea" class="categoryDiv">
                <h1>WORLD</h1>
            </div>

            <div id="technologyArea" class="categoryDiv">
                <h1>TECHNOLOGY</h1>
            </div>

            <div id="sportArea" class="categoryDiv">
                <h1>SPORT</h1>
            </div>
            <!-- <div class="newsCube">
                <div class="newsCubeContent">
                    <a href="https://en.wikipedia.org/wiki/Jeb_Bush"><img class="newsCubeImage" src="https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg"/></a>
                    <a href="http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211"><p class="newsCubeHeadline">JEBSURGE ALERT, Jeb Bush wins US Presidential Election in unexpected landslide</p></a>
                    <p>uk</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="http://newsninja2012.com/wp-content/uploads/2016/08/Screen-Shot-2016-08-04-at-12.57.43-PM.jpg"/>
                    <p class="newsCubeHeadline">Hillary Clinton wins US Presidential Election with 49% of the vote</p>
                    <p>sport</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="http://images.huffingtonpost.com/2016-02-15-1455534387-1672884-nbcfiresdonaldtrumpafterhecallsmexicansrapistsanddrugrunners.jpg"/>
                    <p class="newsCubeHeadline">Trump wins US Presidential Election in "yuge" victory, "really great victory", "tremendous"</p>
                    <p>world</p>
                </div>
            </div>

            <div class="newsCube">
                <div class="newsCubeContent">
                    <a href="http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211"><img class="newsCubeImage" src="http://i.cbc.ca/1.3414124.1456270228!/fileImage/httpImage/image.jpg_gen/derivatives/16x9_1180/putin.jpg"/></a>
                    <a href="http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211"><p class="newsCubeHeadline">Putin listens to US allegations of election tampering and responds incredulously</p></a>
                    <p>technology</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="http://www.onechicmom.com/wp-content/uploads/2016/07/09_theresamay_r_w.jpg"/>
                    <p class="newsCubeHeadline">Watch Theresa May's shock transformation into an amphibian mid press conference</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="http://www.labottegadelbarbieri.org/wp-content/uploads/2015/07/merkel-rating-sp-downgrading-jpg-crop_display.jpg"/>
                    <p class="newsCubeHeadline">Merkel looks concerned</p>
                    <p>technology</p>
                </div>
            </div>

            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="http://15130-presscdn-0-89.pagely.netdna-cdn.com/wp-content/uploads/2016/09/2701a6d0-clinton-4x3.jpg"/>
                    <p class="newsCubeHeadline">Hillary Clinton Assassinated By Trump Supporter</p>
                    <p>world</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="https://i.ytimg.com/vi/e7UcQcD9INI/maxresdefault.jpg"/>
                    <p class="newsCubeHeadline">Donald Trump Assassinated By Hillary Supporter</p>
                    <p>uk</p>
                </div>
            </div>
            <div class="newsCube">
                <div class="newsCubeContent">
                    <img class="newsCubeImage" src="RISE_AGAIN.jpg"/>
                    <p class="newsCubeHeadline">Hillary and Trump Rise Again, Begin Final Battle</p>
                    <p>sport</p>
                </div>
            </div> -->
        </div>
       
        <div id="sideBar">
            <h2>Menu</h2>
            <span id="sideBarButton" onclick="handleSideBarClick()">></span>
            <br>
            <h2>Categories</h2>
            <ul>
                <li><input type="checkbox" id="ukCheck" checked="true">UK</input></li>
                <li><input type="checkbox" id="worldCheck" checked="true">World</input></li>
                <li><input type="checkbox" id="techCheck" checked="true">Technology</input></li>
                <li><input type="checkbox" id="sportCheck" checked="true">Sport</input></li>
            </ul>
        </div>

        <!-- Script to utilise the WebSocket -->
        <script type="text/javascript">
                       
            var webSocket;
            var messages = document.getElementById("messages");


            var test = 
            [
                {
                    "title": "SURGEFEED",
                    "description": "Feed desc.",
                    "updates": [
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "sport",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "world",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "uk",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JOB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JAB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                    ]
                },

                {
                    "title": "JEB",
                    "description": "Feed desc.",
                    "updates": [
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "world",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                        {
                            "title": "JEB",
                            "description": "Article Desc.",
                            "link": "http://www.nbcnews.com/news/world/putin-insists-russia-has-no-intention-influencing-u-s-election-n667211",
                            "pubDate": "1/2/16",
                            "category": "technology",
                            "media": "https://img.4plebs.org/boards/pol/image/1473/80/1473805449404.jpg",
                        },
                    ]
                }
            ]

            var inputElement = document.createElement('button');
            var inputElementText = document.createTextNode("NEWS MAKER");
            inputElement.appendChild(inputElementText);
            inputElement.addEventListener('click', function() {
                updateNews(test);
            });

            ukCheck.addEventListener('change', function() {
                filterNews("uk", ukCheck);
            });

            worldCheck.addEventListener('change', function() {
                filterNews("world", worldCheck);
            });

            techCheck.addEventListener('change', function() {
                filterNews("technology", techCheck);
            });

            sportCheck.addEventListener('change', function() {
                filterNews("sport", sportCheck);
            });

            // document.addEventListener('DOMContentLoaded', function() {
            //     loadPreferences();
            // });

            function loadPreferences() {
                var pattern = /(\w*)CatPref\w*/;
                for (var key in localStorage) {
                    var match = pattern.exec(key);
                    if (match != null) {
                        console.log(document.getElementById(ukCheck));
                        if (localStorage[key] === "true") {
                            [match[1] + "Check"].checked = true;
                            window[match[1]+"Check"].checked = true;
                        } else {
                            window[match[1]+"Check"].checked = false;
                        }
                    }
                }
            }

            document.getElementById("titleHeader").appendChild(inputElement);
           
            function openSocket(){
                // Ensures only one connection is open at a time
                if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
                    console.log("WebSocket is already opened.");
                    return;
                }
                // Create a new instance of the websocket
                webSocket = new WebSocket("ws://localhost:8080/NewsAggregator/test");
                 
                /**
                 * Binds functions to the listeners for the websocket.
                 */
                webSocket.onopen = function(event){
                    console.log("Connection open");
                };
 
                webSocket.onmessage = function(event){
                    console.log("Message arrived");
                    console.log(event);
                    updateNews(event.data);
                };
 
                webSocket.onclose = function(event){
                    console.log("Connection closed");
                };
            }


            var sideBarExpanded = false;

            function expandSideBar() {
                document.getElementById("sideBar").style.width = "250px";
                document.getElementById("newsCubeArea").style.marginLeft = "260px";
                document.getElementById("newsCubeArea").style.width = "88%";
                document.getElementById("sideBarButton").style.marginLeft = "200px";
                document.getElementById("sideBarButton").style.right = "0";
                sideBarExpanded = true;
            }

            function shrinkSideBar() {
                document.getElementById("sideBar").style.width = "40px";
                document.getElementById("newsCubeArea").style.marginLeft = "50px";
                document.getElementById("newsCubeArea").style.width = "100%";
                document.getElementById("sideBarButton").style.marginLeft = "0";
                sideBarExpanded = false;
            }

            function handleSideBarClick() {
                if (sideBarExpanded) {
                    shrinkSideBar();
                } else {
                    expandSideBar();
                }
            }

            var newsStoriesCategorised = {};
            var categories = ["uk", "world", "technology", "sport"];

            newsStoriesCategorised.uk = [];
            newsStoriesCategorised.world = [];
            newsStoriesCategorised.technology = [];
            newsStoriesCategorised.sport = [];

            function updateNews(data) {
                for (var i = 0; i < data.length; i++) {
                    for (var j = 0; j < data[i].updates.length; j++) {
                        var category = data[i].updates[j].category;
                        if (category != "") {
                            if (newsStoriesCategorised[category].indexOf(data[i].updates[j]) === -1) {
                                newsStoriesCategorised[category].push(data[i].updates[j]);
                            } else {
                                console.log("Leaving out dup");
                            }
                        }
                    }
                }
                // console.log(newsStoriesCategorised);
                for (var key in newsStoriesCategorised) {
                    console.log(key);
                    if (!newsStoriesCategorised.hasOwnProperty(key)) continue;
                    for (var i = 0; i < newsStoriesCategorised[key].length; i++) {
                        createNewsCube(newsStoriesCategorised[key][i]);
                    }
                }
            }

            function createCategoryCubes(category) {
                for (var i = 0; i < newsStoriesCategorised[category].length; i++) {
                    createNewsCube(newsStoriesCategorised[category][i]);
                }
            }

            function createNewsCube(storyObject) {
                //Data should be ONE single news story.

                console.log(storyObject);
                var newsCube = document.createElement("div");
                var newsCubeContent = document.createElement("div");

                var newsCubeImageLink = document.createElement("a");
                newsCubeImageLink.setAttribute('href', storyObject.link);

                var newsCubeHeadlineLink = newsCubeImageLink.cloneNode(false);

                var newsCubeHeadline = document.createElement("p");
                var titleTextNode = document.createTextNode(storyObject.title);
                newsCubeHeadline.appendChild(titleTextNode);

                var newsCubeDescription = document.createElement("p");
                var descriptionTextNode = document.createTextNode(storyObject.description);
                newsCubeDescription.appendChild(descriptionTextNode);

                var newsCubeCategory = document.createElement("p");
                var categoryTextNode = document.createTextNode(storyObject.category);
                newsCubeCategory.appendChild(categoryTextNode);

                var categoryDiv = getCategoryDiv(storyObject.category);

                var newsCubeImage = document.createElement("img");
                newsCubeImage.setAttribute('src', storyObject.media);

                newsCube.setAttribute('class', "newsCube");
                newsCubeContent.setAttribute('class', "newsCubeContent");
                newsCubeHeadline.setAttribute('class', "newsCubeHeadline");
                newsCubeDescription.setAttribute('class', "newsCubeDescription");
                newsCubeImage.setAttribute('class', "newsCubeImage");

                document.getElementById(categoryDiv).appendChild(newsCube);
                newsCube.appendChild(newsCubeContent);
                newsCubeContent.appendChild(newsCubeImageLink);
                newsCubeContent.appendChild(newsCubeHeadlineLink);
                newsCubeImageLink.appendChild(newsCubeImage);
                newsCubeHeadlineLink.appendChild(newsCubeHeadline);
                newsCubeContent.appendChild(newsCubeCategory);
                newsCubeHeadlineLink.appendChild(newsCubeDescription);
                // console.log(storyObject);
            }

            function filterNews(filter, checkBox) {
                var newsCubes = document.getElementsByClassName("newsCube");
                // for (var i = 0; i < newsCubes.length; i++) {
                var categoryDiv = document.getElementById(getCategoryDiv(filter));
                if (checkBox.checked) {
                    localStorage.setItem(filter + 'CatPref', 'true');
                    categoryDiv.style.visibility = "visible";
                    // newsCubes[i].style.visibility = "visible";
                    createCategoryCubes(filter);
                } else {
                    localStorage.setItem(filter + 'CatPref', 'false');
                    var categoryChildrenLength = categoryDiv.children.length;
                    for (var i = 1; i < categoryChildrenLength; i++) {
                        categoryDiv.removeChild(categoryDiv.children[1]);
                        console.log(categoryDiv.children.length);
                        console.log(categoryDiv.children);
                    }
                    categoryDiv.style.visibility = "hidden";
                    // newsCubes[i].style.visibility = "hidden";
                }
                    // if (newsCubes[i].children[0].children[2].innerHTML === filter) {
                    // }
                // }
            }

            function getCategoryDiv(category) {
                if (category === "uk") {
                    return "UKArea";
                } else if (category === "world") {
                    return "worldArea";
                } else if (category === "technology") {
                    return "technologyArea";
                } else if (category === "sport") {
                    return "sportArea";
                }
            }



        </script>
       
    </body>
</html>